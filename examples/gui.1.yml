---
name: test

releases:
- name: gui
  version: latest
- name: lexer
  version: latest
- name: calculator
  version: latest
- name: database
  version: latest
- name: a9s-consul
 # sha1: sha256:10c3906c2b2cc70f4e928bc1367df33861200e4545f6540ed15f56005f61adbe
 # url: https://d3r5lzz0qww9ge.cloudfront.net/a9s-consul-27.tgz
  version: 30
- name: routing
  version: 0.193.0
  url: https://bosh.io/d/github.com/cloudfoundry-incubator/cf-routing-release?v=0.193.0
  sha1: sha256:a065f3b85ec28608f727a0db4c7eafbcf899365eebcc6a005961a9d829645f75
- name: bpm
  sha1: sha256:5b5b9acfd286ebbdb9916b68345935783aaec6f21bee6c7f87c3e74ac9eacc7e
  url: https://bosh.io/d/github.com/cloudfoundry/bpm-release?v=1.1.5
  version: 1.1.5

stemcells:
- alias: default
  os: ubuntu-xenial
  version: latest

update:
  canaries: 1
  canary_watch_time: 1000-180000
  max_in_flight: 2
  serial: true
  update_watch_time: 1000-180000

instance_groups:
- name: test
  azs: [z1]
  instances: 1
  vm_type: small
  stemcell: default
  networks:
  - name: dynamic

  jobs:
  - name: consul
    consumes:
      consul_nodes: nil
    properties:
      consul:
        agent_address: 127.0.0.1:8500
        cluster:
          join_hosts:
          - 172.28.35.21
          - 172.28.36.21
          - 172.28.37.21
        dc: dc1
        domain: consul.dsf2
        encrypt: ((/cdns_encrypt))
        server: false
        ssl_ca: ((/cdns_ssl.ca))
        ssl_cert: ((/cdns_ssl.certificate))
        ssl_key: ((/cdns_ssl.private_key))
    release: a9s-consul

  - name: bpm
    release: bpm

  - name: route_registrar
    release: routing
    properties:
      nats:
        machines:
        - 172.28.1.26
        password: ((/cf_user_nats_password))
        port: 4222
        user: nats-user
      route_registrar:
        routes:
        - name: test
          registration_interval: 20s
          port: 80
          tags:
            component: test
            env: production
          uris:
          - "test.system.a9s-ds-concourse.a9s-ops.de"

  - name: nginx
    release: gui
    consumes:
      nodes:
        from: gui
    properties:
      nginx:
        upstream_host: 0.0.0.0
        upstream_port: 80
      gui:
        port: 5000
      consul:
        dc: dc1
        domain: consul.dsf2

  - name: gui
    release: gui
    # provides:
    #   nodes:
    #     as: gui
    properties:
      consul:
        dc: dc1
        domain: consul.dsf2
      gui:
        # all non local addresses
        # 0.0.0.0/0 represents all possible IP addresses. In the context of the way routing tables get set up by default on AWS,
        # 0.0.0.0/0 is effectively "all non local addresses". This is because another route presumably exists in the routing table
        #  to route the VPC subnet to the local network on the VPC.
        host: 0.0.0.0 # because access from public ip
        port: 5000
      database:
        port: 6000
      lexer:
        port: 3000
      calculator:
        port: 4000

  # - name: lexer
  #   release: lexer
  #   properties:
  #     lexer:
  #       host: 0.0.0.0
  #       port: 3000

  # - name: calculator
  #   release: calculator
  #   properties:
  #     calculator:
  #       host: 0.0.0.0
  #       port: 4000

  # - name: database
  #   release: database
  #   properties:
  #     database:
  #       host: 0.0.0.0
  #       port: 6000
